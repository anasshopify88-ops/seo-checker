<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>أداة فحص سيو المتجر الإلكتروني من أنس راشد — نسخة دقيقة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --card-2:#f9fbff;
      --fg:#0c1424; --muted:#5b6472;
      --brand:#2563eb; --brand-2:#22d3ee;
      --ok:#15803d; --warn:#d97706; --danger:#dc2626;
      --border:#e6e9f2; --chip:#eef2ff;
      --sidebar-w:280px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',system-ui,Arial;
      background:linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
      color:var(--fg); display:flex; flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,0.9);
      backdrop-filter:saturate(140%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .nav{
      max-width:1100px; margin:auto; display:flex; align-items:center; justify-content:space-between; padding:0.8rem 1rem;
    }
    .nav .left, .nav .right{display:flex; gap:0.6rem; align-items:center}
    .title h1.nav-h1{margin:0; font-size:1.1rem; line-height:1.4; font-weight:800}
    .btn{appearance:none; border:none; cursor:pointer; border-radius:10px; padding:0.6rem 0.95rem; font-weight:700}
    .btn.brand{ background: linear-gradient(90deg,var(--brand),var(--brand-2)); color:#ffffff }
    .btn.ghost{ background:#eef2ff; color:var(--fg); border:1px solid var(--border)}
    .btn.link{ background:#ffffff; color:#0f172a; text-decoration:none; border:1px solid var(--border)}
    .btn:disabled{ opacity:0.6; cursor:not-allowed }
    main{ flex:1; }
    .container{ max-width:1100px; margin: 1rem auto 2rem; padding: 0 1rem; }

    .layout{ display:grid; grid-template-columns: var(--sidebar-w) 1fr; gap:14px; align-items:start; }
    @media (max-width: 980px){ .layout{ grid-template-columns: 1fr; } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:1rem; box-shadow:0 10px 30px rgba(2,8,23,0.06) }

    #sidePanel{ display:flex; height:100%; min-height:0; overflow:hidden; }
    @media (min-width:981px){ #sidePanel{ contain:size; } }
    .sidebar-card{ flex:1 1 auto; height:100%; display:flex; flex-direction:column; gap:8px; min-height:0; overflow:auto; }
    .avatar{ width:96px; height:96px; border-radius:50%; background:#fff; padding:6px; object-fit:contain; object-position:center; border:1px solid var(--border); align-self:center }
    .logo{ width:100%; max-width:160px; align-self:center; object-fit:contain; object-position:center; background:#fff; border-radius:12px; border:1px solid var(--border); padding:8px }
    .s-list{ display:grid; gap:6px }
    .s-item a{
      display:block; padding:7px 9px; border:1px solid var(--border); border-radius:12px; background:#fff;
      color:#0f172a; text-decoration:none; font-weight:600; transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease;
      box-shadow:0 4px 12px rgba(15,23,42,.05); font-size:12.5px;
    }
    .s-item a:hover{ transform:translateY(-2px); border-color:#cbd5e1; box-shadow:0 8px 18px rgba(15,23,42,.08) }
    .s-caption{ color:var(--muted); font-size:11px; margin-top:-2px; align-self:center }

    .grid{ display:grid; grid-template-columns:1.2fr 0.8fr; gap:1rem; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    /* حقول الإدخال */
    input[type="text"]{
      width:100%; padding:0.85rem 0.9rem; border-radius:12px; background:#ffffff; color:#000;
      border:1px solid var(--border); outline:none; font-size:1rem;
      overflow:hidden; text-overflow:ellipsis; direction:ltr;
      box-shadow:0 6px 20px rgba(2,8,23,0.04);
    }
    .inline{ display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap}
    .inline > *{ flex:1 }
    .chip{ display:inline-flex; gap:0.35rem; align-items:center; padding:0.35rem 0.6rem; border-radius:999px; background:var(--chip); color:#334155; font-size:0.85rem; margin-inline-end:0.5rem}
    .progressbar{ height:10px; background:#eef2ff; border:1px solid var(--border); border-radius:999px; overflow:hidden }
    .progressbar > span{ display:block; height:100%; width:0%; background: linear-gradient(90deg,#22d3ee,#60a5fa,#2563eb)}
    .muted{ color:var(--muted); font-size:0.92rem }

    .badge{ display:inline-flex; gap:0.4rem; align-items:center; background:#eef2ff; color:#1f2a44; border:1px solid var(--border); padding:0.35rem 0.6rem; border-radius:999px}
    .ok{ color:var(--ok) } .warn{color:var(--warn)} .danger{color:var(--danger)}

    .cta{ background:var(--card-2); border:1px dashed #c7d2fe; border-radius:14px; padding:1rem; }
    .pdf-button{ background:#0ea5e9; color:#ffffff }

    .hide{ display:none }
    .footer-note{ color:var(--muted); font-size:0.85rem; margin-top:0.6rem }

    /* KPI grid */
    .kpi-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:0.8rem; }
    @media (max-width: 900px){ .kpi-grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px){ .kpi-grid{ grid-template-columns: 1fr; } }
    .kpi{
      display:flex; flex-direction:column; align-items:center; text-align:center;
      border:1px solid var(--border); border-radius:14px; padding:0.9rem; background:#fff;
      box-shadow:0 8px 22px rgba(2,8,23,0.05);
    }
    .kpi-ico{
      width:56px; height:56px; border-radius:14px;
      display:grid; place-items:center; margin-bottom:0.5rem;
      box-shadow:0 10px 20px rgba(2,8,23,0.06);
      background: radial-gradient(100% 100% at 30% 30%, #e0f2fe 0%, #dbeafe 45%, #e9d5ff 100%);
    }
    .kpi-ico svg{ width:28px; height:28px }
    .kpi-name{ font-weight:700; font-size:0.95rem; line-height:1.3; min-height:2.4em }
    .kpi-val{ font-size:1.4rem; font-weight:800; margin-top:0.25rem; color:#111827 }

    /* صف ذي خانتين في المنتصف */
    .kpi-tail{ display:flex; justify-content:center; gap:0.8rem; margin-top:0.8rem; flex-wrap:wrap;}
    .kpi-tail .kpi{ min-width:220px; flex:0 1 320px; }

    /* تحسين بطاقة حالة الزحف لسطح المكتب */
    .crawl-card .inline{ align-items:flex-start }
    @media (min-width: 901px){
      .crawl-card .inline{
        display:grid; grid-template-columns: 1fr auto; gap:1rem;
      }
      .crawl-card .badge{
        font-size:1.05rem; padding:.45rem .8rem;
      }
      .crawl-card .progressbar{ height:14px; }
      .crawl-card .muted#status-line{ margin-top:.6rem; }
    }

    /* هيدر للجوال */
    @media (max-width:640px){
      .nav{ flex-direction:column; align-items:center; justify-content:flex-start; gap:.5rem; padding:.6rem 1rem; }
      .nav .title{ order:1; text-align:center; width:100%; }
      .nav .right{ order:2; }
      .nav .left{ order:3; justify-content:center; width:100%; }
      .nav .right .logo{ max-width:140px; }
      .title h1.nav-h1{ font-size:1.05rem; }
      .grid .card:first-child{ padding-bottom:1.2rem; }
      #start-btn{ width:100%; }
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="left">
        <button class="btn ghost" id="btn-back">رجوع</button>
        <a class="btn link" href="https://anasrashed.com" id="btn-home">الرئيسية</a>
      </div>
      <div class="title" aria-label="عنوان الصفحة">
        <h1 id="page-h1" class="nav-h1">أداة فحص سيو المتجر الإلكتروني من أنس راشد</h1>
      </div>
      <div class="right">
        <img class="logo" src="https://i.imgur.com/meUEoP7.png" alt="الشعار"
             onerror="this.onerror=null; this.src='https://i.imgur.com/meUEoP7.jpg';">
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="layout" style="margin-top:12px">
        <!-- Sidebar -->
        <aside id="sidePanel">
          <div class="card sidebar-card">
            <img class="avatar" src="https://i.imgur.com/B3UkEQ0.jpg" alt="صورتي" referrerpolicy="no-referrer"
                 onerror="this.onerror=null; this.src='https://i.imgur.com/B3UkEQ0.png';">
            <div class="s-list">
              <div class="s-item"><a href="https://whoami.anasrashed.com" target="_blank" rel="noopener">من أنا؟</a></div>
              <div class="s-item"><a href="https://anasrashed.com/wAXpVym" target="_blank" rel="noopener">دليل السيو الشامل</a></div>
              <div class="s-item"><a href="https://anasrashed.com/eQvbbqP" target="_blank" rel="noopener">أفضل باك لينك</a></div>
              <div class="s-item"><a href="https://anasrashed.com/NApDQYD" target="_blank" rel="noopener">حملة باك لينك شهرية</a></div>
              <div class="s-item"><a href="https://anasrashed.com/ZqyGaBZ" target="_blank" rel="noopener">حل مشكلة خريطة الموقع للباقة بلس</a></div>
              <div class="s-item"><a href="https://serp.anasrashed.com" target="_blank" rel="noopener">أداة SERP بالذكاء الإصطناعي</a></div>
              <div class="s-item"><a href="https://smg.anasrashed.com" target="_blank" rel="noopener">أداة منشئ خريطة الموقع</a></div>
              <div class="s-item"><a href="https://anasrashed.com/blog" target="_blank" rel="noopener">تعلم أكثر</a></div>
              <div class="s-item"><a href="https://anasrashed.com/%D8%AA%D9%88%D8%AB%D9%8A%D9%82-%D8%A7%D9%84%D8%AA%D8%AC%D8%A7%D8%B1%D8%A9-%D8%A7%D9%84%D8%A5%D9%84%D9%83%D8%AA%D8%B1%D9%88%D9%86%D9%8A%D8%A9/page-1494027497" target="_blank" rel="noopener">توثيق التجارة الإلكترونية</a></div>
              <div class="s-item"><a href="https://contact.anasrashed.com" target="_blank" rel="noopener">تواصل معي</a></div>
            </div>
          </div>
        </aside>

        <!-- Tool -->
        
        <section id="toolBox" style="display:flex; flex-direction:column; gap:14px; min-height:0">
          <div class="grid">
            <section class="card">
              <!-- تم حذف (مصدر الروابط) نهائيًا -->
              <input type="text" id="store-url" placeholder="https://example.com" aria-label="أدخل رابط المتجر">

              <div class="inline" style="margin-top:.6rem">
                <div style="align-self:flex-end;">
                  <button class="btn brand" id="start-btn">ابدأ الفحص</button>
                </div>
              </div>
              <div style="margin-top:0.5rem">
                
               
              </div>
            </section>

            <section class="card crawl-card">
              <div class="inline" style="align-items:flex-start">
                <div style="flex:2">
                  <div class="muted">حالة الزحف</div>
                  <div class="progressbar" aria-label="progress">
                    <span id="pbar"></span>
                  </div>
                </div>
                <div style="flex:1;text-align:center">
                  <div class="badge" title="الصفحات المفحوصة / المتوقع">
                    <span>الصفحات</span>
                    <strong><span id="current-page">0</span>/<span id="total-pages">0</span></strong>
                  </div>
                </div>
              </div>
              <div class="muted" id="status-line" style="margin-top:0.5rem">جاهز للبدء</div>
            </section>
          </div>

          <!-- KPI overview -->
          <section class="card" id="overview-card">
            <div class="inline" style="margin:.3rem 0 .8rem">
              <span class="badge">تم فحص <strong id="scanned-count">0</strong> صفحة</span>
              <span class="badge">الزمن: <strong id="exec-time">0</strong> ث</span>
              <span class="badge">النطاق: <strong id="summary-origin">—</strong></span>
            </div>

            <div class="kpi-grid">
              <!-- KPIs الأساسية -->
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M12 3l3.09 6.26L22 10.27l-5 4.88L18.18 22 12 18.77 5.82 22 7 15.15l-5-4.88 6.91-1.01L12 3z" stroke="#2563eb" stroke-width="1.4" fill="#93c5fd"/></svg></div><div class="kpi-name">ON-PAGE SEO Score</div><div class="kpi-val" id="o-score">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="12" rx="2" stroke="#0ea5e9" stroke-width="1.4" fill="#bae6fd"/><rect x="9" y="18" width="6" height="2" rx="1" fill="#0ea5e9"/></svg></div><div class="kpi-name">سرعة الموقع (كمبيوتر)</div><div class="kpi-val" id="speed-desktop">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><rect x="7" y="2" width="10" height="20" rx="2" stroke="#22c55e" stroke-width="1.4" fill="#bbf7d0"/><circle cx="12" cy="18" r="1" fill="#16a34a"/></svg></div><div class="kpi-name">سرعة الموقع (جوال)</div><div class="kpi-val" id="speed-mobile">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="16" height="6" rx="2" fill="#e9d5ff" stroke="#8b5cf6"/><path d="M12 10v4M12 14h-6M12 14h6M6 18h12" stroke="#8b5cf6" stroke-width="1.4"/></svg></div><div class="kpi-name">خريطة موقع (1=موجود)</div><div class="kpi-val" id="sitemap">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><rect x="4" y="5" width="16" height="14" rx="2" fill="#fee2e2" stroke="#ef4444"/><circle cx="9" cy="10" r="2" fill="#ef4444"/><path d="M20 17l-5-4-4 3-3-2-4 3" stroke="#ef4444" stroke-width="1.2"/></svg></div><div class="kpi-name">صور &gt; 100KB</div><div class="kpi-val" id="imgs-large">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M12 3l9 16H3l9-16z" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.4"/><circle cx="12" cy="17" r="1.3" fill="#f59e0b"/><rect x="11.2" y="9" width="1.6" height="5" rx=".8" fill="#f59e0b"/></svg></div><div class="kpi-name">روابط مكسورة</div><div class="kpi-val" id="broken-links">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M5 6h14M12 6v12" stroke="#2563eb" stroke-width="1.6"/><rect x="8" y="10" width="8" height="2" fill="#93c5fd"/></svg></div><div class="kpi-name">عناوين طويلة (&gt;60)</div><div class="kpi-val" id="titles-long">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M7 8h10" stroke="#22c55e" stroke-width="1.6"/><rect x="10.5" y="11" width="3" height="7" fill="#bbf7d0"/></svg></div><div class="kpi-name">عناوين قصيرة (&lt;30)</div><div class="kpi-val" id="titles-short">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><rect x="4" y="5" width="16" height="14" rx="2" fill="#e0f2fe" stroke="#0ea5e9"/><rect x="6" y="8" width="12" height="2" fill="#0ea5e9"/><rect x="6" y="12" width="9" height="2" fill="#93c5fd"/></svg></div><div class="kpi-name">وصف ميتا طويل (&gt;160)</div><div class="kpi-val" id="meta-long">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><rect x="4" y="5" width="16" height="14" rx="2" fill="#ecfeff" stroke="#06b6d4"/><rect x="6" y="8" width="7" height="2" fill="#06b6d4"/></svg></div><div class="kpi-name">وصف ميتا قصير (&lt;80)</div><div class="kpi-val" id="meta-short">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" fill="#d1fae5" stroke="#10b981"/><path d="M8 12h8M10 9h4M10 15h4" stroke="#059669" stroke-width="1.6"/></svg></div><div class="kpi-name">صور بدون Alt</div><div class="kpi-val" id="imgs-no-alt">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M7 12a5 5 0 005-5V6a5 5 0 10-5 6h0z" stroke="#ef4444" stroke-width="1.6"/><path d="M17 12a5 5 0 01-5 5v1a5 5 0 105-6h0z" stroke="#fca5a5" stroke-width="1.6"/></svg></div><div class="kpi-name">روابط طويلة جدًا (&gt;115)</div><div class="kpi-val" id="urls-long">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><rect x="5" y="6" width="10" height="12" rx="2" fill="#ddd6fe" stroke="#7c3aed"/><rect x="9" y="4" width="10" height="12" rx="2" fill="#ede9fe" stroke="#7c3aed"/></svg></div><div class="kpi-name">عناوين مكرّرة</div><div class="kpi-val" id="titles-dup">0</div></div>
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" fill="#fee2e2" stroke="#dc2626" stroke-width="1.6"/><path d="M8 8l8 8" stroke="#dc2626" stroke-width="1.6"/></svg></div><div class="kpi-name">صفحات محظورة</div><div class="kpi-val" id="pages-blocked">0</div></div>
              <!-- تمت إزالة: عدد الصفحات المفحوصة -->
              <div class="kpi"><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" fill="#e0f2fe" stroke="#0ea5e9" stroke-width="1.6"/><path d="M7 13l3 3 7-7" stroke="#0ea5e9" stroke-width="1.8"/></svg></div><div class="kpi-name">Sitemap Score</div><div class="kpi-val" id="smap-score">0</div></div>
            </div>

            <!-- صف أخير بخانتين في الوسط -->
            <div class="kpi-tail">
              <div class="kpi">
                <div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M3 7h18" stroke="#f59e0b" stroke-width="1.4"/><rect x="4" y="8" width="16" height="12" rx="2" fill="#fef3c7" stroke="#f59e0b"/></svg></div>
                <div class="kpi-name">عمر النطاق</div>
                <div class="kpi-val" id="domain-age">—</div>
              </div>
              <div class="kpi">
                <div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" fill="#fee2e2" stroke="#ef4444"/><path d="M8 12h8M12 8v8" stroke="#ef4444" stroke-width="1.6"/></svg></div>
                <div class="kpi-name">Spam Risk (0–100)</div>
                <div class="kpi-val" id="spam-risk">0</div>
              </div>
            </div>
          </section>

          <!-- الدفع / PDF -->
          <section class="card">
            <div class="cta">
              <p>هل تريد التفاصيل الكاملة وخطوات الحل لكل مشكلة؟</p>
              <p>إحصل على تقرير شامل + الحلول في ملف PDF بـ 35 ريال سعودي فقط</p>
              <button class="btn brand" id="payment-btn">انتقل إلى الدفع</button>
              <div id="pdf-section" class="hide" style="margin-top:0.6rem">
                <button class="btn pdf-button" id="pdf-generate-btn">توليد PDF</button>
              </div>
              <div class="footer-note" id="notes"></div>
            </div>
          </section>
        </section>
      </div>
    </div>
  </main>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

  <script>
    /************ إعدادات عامة ************/
    const WORKER_BASE = 'https://seo-checker.anasshopify88.workers.dev';
    const PAYMENT_LINK = '#';
    const RETURN_PARAM = 'paid';
    const RETURN_VALUE = '1';

    // رفع الحد وتثبيت وضع الزحف الشامل
    const MAX_PAGES_FIXED = 100000; // حد مرتفع لتغطية كاملة (العامل يسمح بأكثر)
    const DEPTH_MODE = 'auto';      // auto=عمق مرتفع داخل العامل
    const FORCED_MODE = 'mixed';    // دائمًا زحف شامل (Sitemap + داخلي)

    const el = id => document.getElementById(id);
    const setText = (id, v) => { const n = el(id); if(n) n.textContent = v; };

    // Back/Home
    el('btn-back').addEventListener('click', ()=> history.back());
    el('btn-home').addEventListener('click', ()=> location.href='https://anasrashed.com');

    // حالة الدفع
    document.addEventListener('DOMContentLoaded', ()=>{
      const params = new URLSearchParams(location.search);
      if (params.get(RETURN_PARAM) === RETURN_VALUE) localStorage.setItem('seo_paid','1');
      if (localStorage.getItem('seo_paid') === '1') el('pdf-section').classList.remove('hide');
    });

    // الدفع
    document.getElementById('payment-btn').addEventListener('click', ()=> location.href = PAYMENT_LINK);

    function isValidHttpUrl(value) {
      try { const u = new URL(value); return (u.protocol === 'http:' || u.protocol === 'https:'); } catch { return false; }
    }
    function setProgress(curr, total){
      total = Math.max(1, total);
      setText('current-page', curr);
      setText('total-pages', total);
      const p = el('pbar'); if (p) p.style.width = Math.round((curr/total)*100)+'%';
    }
    function setWorking(state){
      const btn = el('start-btn');
      btn.disabled = state;
      btn.textContent = state ? 'جاري الفحص…' : 'ابدأ الفحص';
    }
    function note(msg){ const n = el('notes'); if (n) n.textContent = msg || ''; }

    function ageLabel(days){
      if (!days || days <= 0) return '—';
      const years = Math.floor(days/365);
      const months = Math.floor((days%365)/30);
      if (years && months) return `${years} سنة و ${months} شهر`;
      if (years) return `${years} سنة`;
      if (months) return `${months} شهر`;
      return `${days} يوم`;
    }

    /************ النقرة الرئيسية ************/
    el('start-btn').addEventListener('click', async ()=>{
      const url = el('store-url').value.trim();
      if (!isValidHttpUrl(url)) {
        el('status-line').textContent = 'رجاءً أدخل رابط متجر صالح يبدأ بـ http(s)://';
        return;
      }

      el('status-line').textContent = 'بدء الزحف الشامل لكل روابط الموقع…';
      setProgress(0, MAX_PAGES_FIXED);
      setWorking(true);
      note('');

      const t0 = performance.now();
      try {
        const crawlURL = new URL('/crawl', WORKER_BASE);
        crawlURL.searchParams.set('url', url);
        crawlURL.searchParams.set('max', String(MAX_PAGES_FIXED));
        crawlURL.searchParams.set('depth', DEPTH_MODE); // auto
        crawlURL.searchParams.set('mode', FORCED_MODE); // mixed دائمًا

        const resp = await fetch(crawlURL, { method:'GET' });
        if (!resp.ok) throw new Error('فشل الاتصال بالزاحف');
        const data = await resp.json();

        // تقدير إجمالي الصفحات
        const estimatedTotal = Math.max(
          data?.pages?.length || 0,
          data?.sitemap_info?.discovered_urls_count || 0,
          1
        );
        setProgress(Math.min(estimatedTotal, (data.pages?.length || 0)), Math.max(estimatedTotal, 1));
        el('status-line').textContent = 'تحليل النتائج…';

        const summary = computeSummary(data);
        const t1 = performance.now();

        // PageSpeed + Domain Age + SpamRisk من السيرفر
        const metricsURL = new URL('/metrics', WORKER_BASE);
        const domain = new URL(data.origin).hostname;
        metricsURL.searchParams.set('domain', domain);

        let metrics = { psi_mobile:null, psi_desktop:null, domain_age_days:null, spam_risk:null, spam_reasons:[] };
        try {
          const mx = await fetch(metricsURL, { method:'GET' });
          if (mx.ok) metrics = await mx.json();
        } catch {}

        fillSummary(summary, data.origin, metrics);
        setText('scanned-count', summary.pagesScanned);
        setText('exec-time', ((t1 - t0)/1000).toFixed(2));
        el('status-line').textContent = 'انتهى الفحص ✔️';

        // حفظ لأجل PDF
        window.__CRAWL_DATA__ = data;
        window.__SUMMARY__ = summary;
        window.__METRICS__ = metrics;

        const allReasons = []
          .concat(data.spam_reasons_partial || [])
          .concat(metrics.spam_reasons || []);
        if (allReasons.length){
          note('أسباب Spam Risk: ' + Array.from(new Set(allReasons)).join(' • '));
        }

      } catch (e){
        el('status-line').textContent = 'خطأ أثناء الفحص: ' + e.message;
      } finally {
        setWorking(false);
      }
    });

    /************ الحسابات ************/
    function computeSummary(data){
      const pages = data.pages || [];
      const pagesScanned = pages.length;

      let scores = [], imgsLarge=0, brokenLinks=0, titlesLong=0, titlesShort=0, metaLong=0, metaShort=0, imgsNoAlt=0, urlsLong=0, titlesDup=0, pagesBlocked=0;
      let speedD=[], speedM=[];
      const titlesCount = {};
      for (const page of pages){
        const title = (page.title || '').trim();
        if (title.length > 60) titlesLong++;
        if (title.length && title.length < 30) titlesShort++;
        if (title) titlesCount[title] = (titlesCount[title]||0) + 1;

        const meta = page.description || '';
        if (meta.length > 160) metaLong++;
        if (meta && meta.length < 80) metaShort++;

        imgsLarge += page.total_img_over_100kb || 0;

        const imgs = Array.isArray(page.images)? page.images : [];
        for (const img of imgs) if (!img.alt || img.alt.trim()==='') imgsNoAlt++;

        if (page.url && page.url.length > 115) urlsLong++;
        if (page.blocked) pagesBlocked++;
        brokenLinks += page.broken_links_count || 0;

        const sD = estimateSpeedScore(page,false); speedD.push(sD);
        const sM = estimateSpeedScore(page,true);  speedM.push(sM);

        scores.push(estimateOnPageScore(page, sD, sM));
      }
      for (const t in titlesCount) if (titlesCount[t] > 1) titlesDup += (titlesCount[t]-1);

      const avg = arr => arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;

      return {
        pagesScanned,
        onPageScore: Number(avg(scores).toFixed(1)),
        speedDesktop: Number(avg(speedD).toFixed(1)),
        speedMobile:  Number(avg(speedM).toFixed(1)),
        imgsLarge, brokenLinks,
        sitemapExists: !!data.sitemap_exists,
        smapScore: Math.round(data.smap_score || 0),
        titlesLong, titlesShort, metaLong, metaShort, imgsNoAlt, urlsLong, titlesDup, pagesBlocked
      };
    }

    function estimateOnPageScore(page, sd, sm){
      let score = 0;
      const title = page.title || '';
      if (title.length >= 30 && title.length <= 60) score += 10;
      const meta = page.description || '';
      if (meta.length >= 80 && meta.length <= 160) score += 10;

      const h1 = page.h1 || '';
      if (h1 && title && h1.trim() === title.trim()) score += 10; else if (h1) score += 6;

      if (page.canonical && /^https?:\/\//.test(page.canonical)) score += 5;
      if (!page.blocked) score += 5;

      const imgs = Array.isArray(page.images)? page.images : [];
      const noAlt = imgs.filter(i => !i.alt || i.alt.trim()==='').length;
      if (imgs.length === 0) score += 10;
      else {
        const ratio = noAlt / imgs.length;
        if (ratio < 0.05) score += 10;
        else if (ratio < 0.20) score += 6;
      }

      if (page.url && page.url.length <= 115 && !page.url.includes('?')) score += 5;
      const h = page.headersSubset || {};
      if (h['og:title'] || h['twitter:title']) score += 5;
      if (page.internal_links && page.internal_links.length >= 5) score += 5;

      const sp = (sd + sm)/2;
      score += sp * 0.2;

      return Math.min(100, Math.round(Math.max(0, score)));
    }

    function estimateSpeedScore(page, mobile){
      let s = 100;
      const big = page.total_img_over_100kb||0;
      s -= Math.min(big*(mobile?1.5:1), 30);

      const blocks = (page.css_blocks||0) + (page.js_blocks||0);
      s -= Math.min(blocks*(mobile?2:1), 20);

      const imgs = page.images || [];
      if (imgs.length){
        const lazy = imgs.filter(i => i.loading==='lazy').length;
        if ((lazy/imgs.length) < 0.2) s -= (mobile?15:10);
      }
      const ratio = page.modern_formats_ratio || 0;
      if (ratio < 0.5) s -= (mobile?10:5);
      if (!page.compression) s -= (mobile?10:5);
      return Math.max(0, Math.round(s));
    }

    function fillSummary(s, origin, metrics){
      setText('summary-origin', origin || '—');

      setText('o-score', s.onPageScore);
      setText('speed-desktop', (metrics.psi_desktop ?? s.speedDesktop));
      setText('speed-mobile',  (metrics.psi_mobile  ?? s.speedMobile));

      setText('sitemap', s.sitemapExists ? 1 : 0);
      setText('smap-score', s.smapScore || 0);
      setText('domain-age', ageLabel(metrics.domain_age_days || 0));
      setText('spam-risk', Math.round(metrics.spam_risk ?? 0));

      setText('imgs-large', s.imgsLarge);
      setText('broken-links', s.brokenLinks);
      setText('titles-long', s.titlesLong);
      setText('titles-short', s.titlesShort);
      setText('meta-long', s.metaLong);
      setText('meta-short', s.metaShort);
      setText('imgs-no-alt', s.imgsNoAlt);
      setText('urls-long', s.urlsLong);
      setText('titles-dup', s.titlesDup);
      setText('pages-blocked', s.pagesBlocked);
    }

    /************ توليد PDF ************/
    document.getElementById('pdf-generate-btn').addEventListener('click', ()=>{
      if (localStorage.getItem('seo_paid') !== '1'){
        document.getElementById('status-line').textContent = 'يجب تفعيل الوضع المدفوع أولاً';
        return;
      }
      const data = window.__CRAWL_DATA__, summary = window.__SUMMARY__ || computeSummary(data), metrics = window.__METRICS__ || {};
      generatePDF(data, summary, metrics);
    });

    function generatePDF(data, summary, metrics){
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF){
        document.getElementById('status-line').textContent = 'لم يتم تحميل مكتبة PDF';
        return;
      }

      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const W = doc.internal.pageSize.getWidth(), H = doc.internal.pageSize.getHeight();
      const M = 40; let y = M;

      doc.setFontSize(18); doc.text('تقرير SEO شامل', W/2, y, {align:'center'}); y += 28;
      doc.setFontSize(12);
      doc.text(`الموقع: ${document.getElementById('store-url').value}`, M, y); y += 18;
      doc.text(`التاريخ: ${new Date().toLocaleDateString('ar-SA')}`, M, y); y += 18;
      doc.text(`الصفحات المفحوصة: ${summary.pagesScanned}`, M, y); y += 26;

      doc.setFontSize(14); doc.text('الملخص العام', M, y); y += 20;
      doc.setFontSize(12);
      const lines = [
        ['ON-PAGE', summary.onPageScore],
        ['سرعة (كمبيوتر)', metrics.psi_desktop ?? summary.speedDesktop],
        ['سرعة (جوال)',   metrics.psi_mobile  ?? summary.speedMobile],
        ['Sitemap Score', summary.smapScore],
        ['Spam Risk', Math.round(metrics.spam_risk ?? 0)],
        ['سitemap', summary.sitemapExists? 'موجود':'غير موجود'],
        ['صور >100KB', summary.imgsLarge],
        ['روابط مكسورة', summary.brokenLinks],
        ['عناوين طويلة', summary.titlesLong],
        ['عناوين قصيرة', summary.titlesShort],
        ['Meta طويل', summary.metaLong],
        ['Meta قصير', summary.metaShort],
        ['صور بلا Alt', summary.imgsNoAlt],
        ['روابط طويلة', summary.urlsLong],
        ['عناوين مكررة', summary.titlesDup],
        ['صفحات محظورة', summary.pagesBlocked],
        ['عمر النطاق', (function(){ const d=metrics.domain_age_days||0; return d? (d+' يوم ('+ (d/365).toFixed(2) +' سنة تقريباً)') : 'غير متاح'; })()],
      ];
      for (const [k,v] of lines){
        doc.text(`${k}: ${v}`, M, y); y += 16; if (y > H - M){ doc.addPage(); y = M; }
      }

      doc.addPage(); y = M; doc.setFontSize(14); doc.text('تفاصيل صفحات مختارة', M, y); y += 20; doc.setFontSize(12);
      const long = (data.pages||[]).filter(p=> (p.title||'').length > 60).slice(0, 12);
      if (long.length){
        doc.text('عناوين طويلة (>60):', M, y); y += 16;
        for (const p of long){
          const t = `- ${p.url} (${(p.title||'').length})`;
          doc.text(t, M+10, y); y += 14; if (y > H - M){ doc.addPage(); y = M; }
        }
      }

      doc.addPage(); y = M; doc.setFontSize(14); doc.text('طريقة الحل لكل مشكلة', M, y); y += 20; doc.setFontSize(12);
      const solutions = [
        ['عنوان طويل', 'اجعل العنوان بين 30-60 حرفًا وضمّن الكلمة الرئيسية مبكرًا.'],
        ['عنوان قصير', 'زد الوصف ليعكس محتوى الصفحة (≥30 حرف).'],
        ['Meta طويل',  'قلّصه إلى 80-160 حرفًا مع CTA.'],
        ['Meta قصير',  'أضف تفاصيل مفيدة ودعوة للفعل.'],
        ['صور بلا Alt', 'أضف alt وصِف الصورة بدقة وسياق.'],
        ['روابط مكسورة', 'حدّث/احذف الروابط غير الصالحة؛ استخدم 301 حيث يلزم.'],
        ['روابط طويلة', 'بسّط المسارات وتجنّب المعاملات غير الضرورية.'],
        ['عناوين مكررة', 'اجعل عنوان كل صفحة فريدًا مع تمييز.'],
        ['صفحات محظورة', 'راجع noindex و robots.txt بدقّة واستخدمهما بوعي.']
      ];
      for (const [a,b] of solutions){
        doc.text(`- ${a}: ${b}`, M, y); y += 16; if (y > H - M){ doc.addPage(); y = M; }
      }

      doc.save('seo-report.pdf');
    }
  </script>
</body>
</html>
